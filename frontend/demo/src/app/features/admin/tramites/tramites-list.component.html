<div class="admin-tramites-container">
  <h1 class="page-title">Gestión de Trámites</h1>
  <p class="page-subtitle">Consulta y gestiona los trámites agrupados por su estado actual.</p>

  @if (panels().length > 0) {
    <mat-accordion multi="false" class="tramites-accordion">
      @for (panel of panels(); track panel.name) {
        <mat-expansion-panel
          (opened)="togglePanel(panel.name)"
          [expanded]="expandedPanel() === panel.name"
          class="tramite-panel"
        >
          <mat-expansion-panel-header>
            <mat-panel-title class="panel-title">
              {{ panel.name | titlecase }}
            </mat-panel-title>
            <mat-panel-description class="panel-description">
              @if (!panel.isLoading && !panel.error) {
                <span>{{ panel.tramites.length }} Trámite(s)</span>
              }
            </mat-panel-description>
          </mat-expansion-panel-header>

          <ng-template matExpansionPanelContent>
            <div class="panel-content">
              @if (panel.isLoading) {
                <div class="loading-indicator">
                  <mat-spinner diameter="40"></mat-spinner>
                  <p>Cargando trámites...</p>
                </div>
              } @else if (panel.error) {
                <div class="error-message">
                  <mat-icon color="warn">error_outline</mat-icon>
                  <p>{{ panel.error }}</p>
                </div>
              } @else if (panel.tramites.length === 0) {
                <div class="no-results">
                  <mat-icon>inbox</mat-icon>
                  <p>No hay trámites en este estado.</p>
                </div>
              } @else {
                <div class="table-container mat-elevation-z2">
                  <table mat-table [dataSource]="panel.tramites">
                    <!-- Columns Definition -->
                    <ng-container matColumnDef="numeroRadicado">
                      <th mat-header-cell *matHeaderCellDef># Radicado</th>
                      <td mat-cell *matCellDef="let row">{{ row.numeroRadicado }}</td>
                    </ng-container>

                    <ng-container matColumnDef="TipoTramiteNombre">
                      <th mat-header-cell *matHeaderCellDef>Tipo de Trámite</th>
                      <td mat-cell *matCellDef="let row">{{ row.TipoTramiteNombre }}</td>
                    </ng-container>

                    <ng-container matColumnDef="creadoEn">
                      <th mat-header-cell *matHeaderCellDef>Creado</th>
                      <td mat-cell *matCellDef="let row">{{ row.creadoEn | date: 'short' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="ultimoMovimiento">
                      <th mat-header-cell *matHeaderCellDef>Último Movimiento</th>
                      <td mat-cell *matCellDef="let row">{{ row.ultimoMovimiento | date: 'short' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="funcionarioAsignado">
                      <th mat-header-cell *matHeaderCellDef>Funcionario</th>
                      <td mat-cell *matCellDef="let row">
                        @if(row.funcionarioAsignado) {
                          <span>{{ row.funcionarioAsignado }}</span>
                        } @else {
                          <mat-form-field appearance="outline" class="funcionario-select">
                            <mat-label>Asignar a...</mat-label>
                            <mat-select (selectionChange)="asignarFuncionario(panel.name, row, $event.value)">
                              @for(funcionario of funcionarios(); track funcionario.id) {
                                <mat-option [value]="funcionario.id">{{ funcionario.email }}</mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                        }
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="correoSolicitante">
                      <th mat-header-cell *matHeaderCellDef>Solicitante</th>
                      <td mat-cell *matCellDef="let row">{{ row.correoSolicitante }}</td>
                    </ng-container>

                    <ng-container matColumnDef="adjuntos">
                      <th mat-header-cell *matHeaderCellDef>Adjuntos</th>
                      <td mat-cell *matCellDef="let row">
                        @if (row.adjuntos && row.adjuntos.length > 0) {
                          <ul class="attachment-list">
                            @for (adjunto of row.adjuntos; track adjunto.nombreArchivo) {
                              <li>
                                <a [href]="adjunto.urlDescarga" target="_blank" rel="noopener">
                                  <mat-icon>attach_file</mat-icon>
                                  <span>{{ adjunto.nombreArchivo }}</span>
                                </a>
                              </li>
                            }
                          </ul>
                        } @else {
                          <span>Ninguno</span>
                        }
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="seguimiento">
                      <th mat-header-cell *matHeaderCellDef> Seguimiento </th>
                      <td mat-cell *matCellDef="let row">
                        <a mat-icon-button [routerLink]="['/admin/tramites', row.numeroRadicado, 'seguimiento']" matTooltip="Ver historial del trámite">
                          <mat-icon>history</mat-icon>
                        </a>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="acciones">
                      <th mat-header-cell *matHeaderCellDef>Acciones</th>
                      <td mat-cell *matCellDef="let row">
                        @if (panel.name === 'EN_PROCESO' && row.funcionarioAsignado) {
                          <button mat-icon-button [matMenuTriggerFor]="menu">
                            <mat-icon>more_vert</mat-icon>
                          </button>
                          <mat-menu #menu="matMenu">
                            @for(state of finalStates; track state) {
                              <button mat-menu-item (click)="cambiarEstado(panel.name, row, state)">
                                <span>{{ state | titlecase }}</span>
                              </button>
                            }
                          </mat-menu>
                        }
                      </td>
                    </ng-container>

                    <!-- Header and Row Declaration -->
                    <tr mat-header-row *matHeaderRowDef="['numeroRadicado', 'TipoTramiteNombre', 'creadoEn', 'ultimoMovimiento', 'funcionarioAsignado', 'correoSolicitante', 'adjuntos', 'seguimiento', 'acciones']"></tr>
                    <tr mat-row *matRowDef="let row; columns: ['numeroRadicado', 'TipoTramiteNombre', 'creadoEn', 'ultimoMovimiento', 'funcionarioAsignado', 'correoSolicitante', 'adjuntos', 'seguimiento', 'acciones'];"></tr>
                  </table>
                </div>
              }
            </div>
          </ng-template>
        </mat-expansion-panel>
      }
    </mat-accordion>
  }
</div>
